{"version":3,"sources":["kee_frame/fsm/alpha.cljc"],"mappings":"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","names":["kee-frame.fsm.alpha/reg-no-op","id","re_frame.core.reg_event_fx","kee-frame.interceptors/add-global-interceptors","cljs.core/constantly","kee-frame.fsm.alpha/find-transition","transitions","event","cljs.core/seq","cljs.core.get","G__41536","G__41537","cljs.core/butlast","kee-frame.fsm.alpha/event-transition!","temp__5735__auto__","transition","map__41544","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","next-state","dispatch","seq__41546","chunk__41547","count__41548","i__41549","cljs.core/chunked-seq?","c__4556__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","e","re-frame.core/dispatch","p__41562","vec__41563","cljs.core.nth","kee-frame.fsm.alpha/foreign-event?","fsm-id","event-id","_","event-fsm-id","and__4115__auto__","fexpr__41569","cljs.core.not_EQ_","kee-frame.fsm.alpha/next-state","fsm","db","map__41571","state-attr","start","transition-map","current-state","cljs.core.get_in","kee-frame.fsm.alpha/compile-timeouts","cljs.core.map","p__41577","vec__41578","state","cljs.core.filter","p__41590","vec__41591","vec__41594","fexpr__41597","cljs.core.mapv","p__41581","vec__41582","vec__41585","timeout","or__4126__auto__","cljs.core.into","kee-frame.fsm.alpha/clear-timeouts!","timeouts*","seq__41598","cljs.core/deref","chunk__41599","count__41600","i__41601","t","kee-frame.interop/clear-timeout","cljs.core/reset!","kee-frame.fsm.alpha/dispatch-timeouts!","timeouts","p__41605","map__41606","ms","kee-frame.interop/set-timeout","kee-frame.fsm.alpha/state-changed?","prev","next","cljs.core/not","kee-frame.fsm.alpha/advance","state->timeouts","map__41611","stop","G__41613","cljs.core._EQ_","cljs.core/assoc-in","re-frame.core/reg-fx","p__41614","map__41615","cljs.core.atom","cljs.core.partial","re-frame.core/enrich","kee-frame.interceptors/reg-global-interceptor","p__41618","map__41619","kee-frame.interceptors/clear-global-interceptor","p__41621","vec__41622","p__41625","vec__41626","re_frame.core.reg_sub","p__41629","vec__41630","map__41633","cljs.spec.alpha/def-impl","cljs.spec.alpha/and-spec-impl","cljs.core/vector?","cljs.spec.alpha/cat-impl","cljs.core/symbol?","cljs.core/any?","js/kee-frame","js/kee-frame.fsm","js/kee-frame.fsm.alpha","js/kee-frame.fsm.alpha.step","method-table__4619__auto__","prefer-table__4620__auto__","method-cache__4621__auto__","cached-hierarchy__4622__auto__","hierarchy__4623__auto__","fexpr__41638","cljs.core/MultiFn","cljs.core.symbol","kee-frame.fsm.alpha/step","re_frame.core.subscribe","kee-frame.fsm.alpha/render*","args","with-let41639","reagent.ratom/with-let-values","temp__5739__auto__","reagent.ratom/*ratom-context*","c__36564__auto__","reagent.debug/has-console","reagent.debug/tracking","reagent.debug/track-console","js/console","init41640","res__36565__auto__","destroy__36563__auto__","reagent.ratom/reactive?","cljs.core/apply","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","kee-frame.fsm.alpha/render","seq41643","G__41644","self__4723__auto__","fsm-fn"],"sourcesContent":["(ns kee-frame.fsm.alpha\n  (:require [clojure.spec.alpha :as s]\n            [re-frame.core :as f]\n            [kee-frame.interop :as interop]\n            [kee-frame.interceptors :as i]\n            #?(:cljs [reagent.core :as r])))\n\n(defn reg-no-op\n  \"Convenience function for declaring no-op events.\"\n  [id]\n  (f/reg-event-fx id\n                  [i/add-global-interceptors]\n                  (constantly nil)))\n\n(defn find-transition\n  \"Try to find a transition that matches some subset of the received event\"\n  [transitions event]\n  (when (seq event)\n    (get transitions event\n         (find-transition transitions (butlast event)))))\n\n(defn- event-transition!\n  \"Given a transition map and an event, returns the next fsm state if\n  there is a valid transition, `nil` otherwise. Event transition\n  `:when` clause is optionally applied.\"\n  [transitions event]\n  (when-let [transition (find-transition transitions event)]\n    (let [{next-state :to\n           dispatch   :dispatch} transition]\n      (when dispatch\n        (doseq [e dispatch]\n          (f/dispatch e)))\n      next-state)))\n\n(defn foreign-event? [fsm-id [event-id _ event-fsm-id]]\n  (and (#{::on-enter ::timeout} event-id)\n       (not= fsm-id event-fsm-id)))\n\n(defn next-state\n  \"Returns next state if there is a valid transition, `nil` otherwise.\"\n  [fsm db event]\n  (let [{id  :id state-attr :state-attr start :start transition-map :fsm\n         :or {state-attr ::state}} fsm\n        current-state (get-in db [id state-attr] start)\n        transitions   (get transition-map current-state)]\n    (when-not (foreign-event? id event)\n      (event-transition! transitions event))))\n\n;;;;;;;;;;;; Timeout implementation ;;;;;;;;;;;;;;;;;;;\n\n(reg-no-op ::timeout)\n(reg-no-op ::on-enter)\n(reg-no-op ::fsm-started)\n\n\n(reg-no-op :default-on-failure)\n\n(defn compile-timeouts [fsm]\n  (->> fsm\n       :fsm\n       (map (fn [[state transitions]]\n              [state (->> transitions\n                          (filter (fn [[[event-id]] _]\n                                    (#{::timeout ::on-enter} event-id)))\n                          (mapv (fn [[[event-id timeout]] _]\n                                  (let [timeout (or timeout 0)]\n                                    {:ms timeout :dispatch [event-id timeout (:id fsm)]}))))]))\n       (into {})))\n\n(defn clear-timeouts! [timeouts*]\n  (doseq [t @timeouts*]\n    (interop/clear-timeout t))\n  (reset! timeouts* []))\n\n(defn dispatch-timeouts! [timeouts* timeouts]\n  (->> timeouts\n       (mapv (fn [{:keys [ms dispatch]}]\n               (interop/set-timeout #(f/dispatch dispatch) ms)))\n       (reset! timeouts*)))\n\n(defn state-changed? [prev next]\n  (or\n   (not prev)\n   next))\n\n(defn advance\n  \"Given a parsed fsm, a db, and an event, advances the fsm. Else,\n  no-op.\"\n  [fsm timeouts* state->timeouts db event]\n  (let [{:keys [id state-attr stop start] :or {state-attr ::state}} fsm\n        current-state (get-in db [id state-attr])\n        next-state    (next-state fsm db event)]\n    (when (state-changed? current-state next-state)\n      (clear-timeouts! timeouts*)\n      (dispatch-timeouts! timeouts* (state->timeouts (or next-state start))))\n    (when (and stop (= next-state stop))\n      (f/dispatch [::stop fsm]))\n    (assoc-in db [id state-attr] (or next-state current-state start))))\n\n\n(f/reg-fx ::start\n          (fn [{:keys [id] :as fsm}]\n            (let [timeouts*       (atom nil)\n                  state->timeouts (compile-timeouts fsm)]\n              (->> (partial advance fsm timeouts* state->timeouts)\n                   f/enrich\n                   (i/reg-global-interceptor id)))))\n\n(f/reg-fx ::stop\n          (fn [{:keys [id]}]\n            (when id\n              (i/clear-global-interceptor id))))\n\n(f/reg-event-fx ::start\n                ;; Starts the interceptor for the given fsm.\n  (fn [_ [_ fsm]]\n    {::start   fsm\n     :dispatch [::fsm-started]}))\n\n(f/reg-event-fx ::stop\n  ;; Stops the interceptor for the given fsm.\n  (fn [_ [_ fsm]]\n    {::stop fsm}))\n\n(f/reg-sub ::state\n  (fn [db [_ {:keys [id state-attr start]\n              :or   {state-attr ::state}}]]\n    (get-in db [id state-attr] start)))\n\n(s/def ::binding (s/and vector?\n                        (s/cat :fsm-symbol symbol? :fsm any?)))\n\n(defmacro with-fsm [binding & body]\n  (let [parsed (s/conform ::binding binding)]\n    (when (= ::s/invalid parsed)\n      (throw (ex-info \"with-fsm accepts exactly one binding pair, the symbol and the value containing the fsm.\"\n                      (s/explain-data ::binding binding))))\n    (let [{:keys [:fsm-symbol :fsm]} parsed]\n      `(reagent.core/with-let [~fsm-symbol ~fsm\n                               _# (f/dispatch [::start ~fsm-symbol])]\n         ~@body\n         ~(list\n           'finally\n           `(re-frame.core/dispatch [::stop ~fsm-symbol]))))))\n\n(defmulti step\n  \"Materialized view of the current fsm state. A `step` method must\n  exist for each state defined in the fsm transition map. States are\n  globally defined, and namespaced keywords are required. It is a good\n  idea to define the fsm in the same namespace as the steps.\"\n  (fn [fsm & _]\n    @(f/subscribe [::state fsm])))\n\n(defmethod step :default\n  [fsm & _]\n  [:h2 (str \"Undefined step: \" @(f/subscribe [::state fsm]))])\n\n#?(:cljs\n   (defn- render*\n     [fsm args]\n     (r/with-let [_ (f/dispatch [::start fsm])]\n       [apply step fsm args]\n       (finally\n        (f/dispatch [::stop fsm])))))\n\n#?(:cljs\n   (defn render\n     \"Given an fsm function and arguments, renders a materialized view of\n     the fsm state. A `step` method must exist for each state defined in\n     the fsm transition map. The args passed to `render` must match the\n     args expected by the fsm's `step` methods.\"\n     [fsm-fn & args]\n     (let [fsm (apply fsm-fn args)]\n       ^{:key (:id fsm)} [render* fsm args])))"]}